# LivePush 产品需求文档 (PRD)

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2024-12-30 | - | 初始版本 |

---

## 1. 产品概述

### 1.1 产品定位

LivePush 是一款轻量级的 Android 端直播推流工具，支持 RTMP 和 WebRTC 双协议推流，**面向个人用户**，无需账号登录，开箱即用，提供稳定、低延迟、高画质的推流体验。

### 1.2 目标用户

| 用户群体 | 使用场景 | 核心需求 |
|----------|----------|----------|
| 个人用户 | 游戏直播、户外直播、生活分享 | 简单易用、快速上手 |
| 技术爱好者 | 自建直播服务测试 | 灵活配置、协议支持 |
| 远程监控 | 家庭监控、临时监控 | 稳定性、后台运行 |

### 1.3 核心价值

1. **开箱即用**: 无需账号注册，安装即可使用
2. **双协议支持**: RTMP (传统直播) + WebRTC (低延迟互动)
3. **专业级画质**: 支持 1080P/60fps，硬件编码
4. **简单易用**: 一键开播，支持扫码输入地址
5. **稳定可靠**: 断线重连，弱网自适应

---

## 2. 功能需求

### 2.1 功能架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         LivePush App                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   首页      │  │   推流页    │  │   设置页    │              │
│  │  快速开始   │  │  实时预览   │  │  参数配置   │              │
│  │  扫码输入   │  │  推流控制   │  │  历史记录   │              │
│  │  历史记录   │  │  摄像头切换 │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      核心功能模块                          │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         │  │
│  │  │视频采集 │ │音频采集 │ │视频编码 │ │音频编码 │         │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘         │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         │  │
│  │  │美颜滤镜 │ │水印叠加 │ │RTMP推流 │ │WebRTC  │         │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘         │  │
│  │  ┌─────────┐                                              │  │
│  │  │二维码   │                                              │  │
│  │  │扫描     │                                              │  │
│  │  └─────────┘                                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 功能模块详情

#### 2.2.1 首页模块

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 快速开始 | 一键进入推流页面 | P0 |
| 协议选择 | RTMP / WebRTC 切换 | P0 |
| 推流地址输入 | 手动输入推流地址 | P0 |
| 粘贴地址 | 从剪贴板粘贴地址 | P0 |
| 二维码扫描 | 扫描二维码获取推流地址 | P0 |
| 历史记录 | 查看/选择历史推流地址 | P1 |
| 地址管理 | 编辑/删除已保存的地址 | P1 |

#### 2.2.2 推流模块

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 实时预览 | 显示摄像头画面 | P0 |
| 开始/停止推流 | 控制推流状态 | P0 |
| 前后摄像头切换 | 切换摄像头 | P0 |
| 闪光灯控制 | 开关闪光灯 | P1 |
| 静音控制 | 麦克风静音 | P0 |
| 推流状态显示 | 码率、帧率、延迟、时长 | P0 |
| 横竖屏切换 | 支持横竖屏推流 | P0 |
| 画面缩放 | 手势缩放画面 | P2 |
| 对焦控制 | 点击对焦 | P1 |

#### 2.2.3 美颜滤镜模块

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 基础美颜 | 磨皮、美白、红润 | P1 |
| 滤镜效果 | 多种风格滤镜 | P2 |
| 美颜强度调节 | 0-100% 可调 | P1 |
| 实时预览 | 美颜效果实时显示 | P1 |

#### 2.2.4 水印模块

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 图片水印 | 添加 Logo 水印 | P1 |
| 文字水印 | 添加文字水印 | P1 |
| 时间水印 | 实时显示时间戳 | P2 |
| 位置调整 | 四角 + 自定义位置 | P1 |
| 透明度调节 | 水印透明度可调 | P2 |

#### 2.2.5 设置模块

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 视频参数 | 分辨率、帧率、码率 | P0 |
| 音频参数 | 采样率、码率、声道 | P0 |
| 编码器选择 | H.264/H.265 选择 | P1 |
| 网络设置 | 重连策略、超时时间 | P1 |
| 推流服务器 | STUN/TURN 服务器配置 | P1 |
| 高级设置 | 关键帧间隔、B帧等 | P2 |

---

## 3. 界面设计

### 3.1 页面流程图

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│  启动页  │────▶│  首页   │────▶│ 推流页  │
│ Splash  │     │  Home   │     │ Stream  │
└─────────┘     └────┬────┘     └────┬────┘
                     │               │
          ┌──────────┼──────────┐    │
          ▼          ▼          ▼    ▼
     ┌─────────┐ ┌─────────┐ ┌──────────┐
     │ 扫码页  │ │ 设置页  │ │ 美颜面板 │
     │  Scan   │ │Settings │ │ Beauty   │
     └─────────┘ └─────────┘ └──────────┘
```

### 3.2 首页设计

```
┌─────────────────────────────────────┐
│  LivePush                      [⚙️] │  ← 顶部栏 + 设置入口
├─────────────────────────────────────┤
│                                     │
│    ┌─────────────────────────┐     │
│    │                         │     │
│    │      [摄像头预览]        │     │  ← 小窗预览
│    │                         │     │
│    └─────────────────────────┘     │
│                                     │
│    推流地址                         │
│    ┌───────────────────┬───┬───┐   │
│    │ rtmp://server/... │📋 │📷 │   │  ← 输入框 + 粘贴 + 扫码
│    └───────────────────┴───┴───┘   │
│                                     │
│    ┌──────────┐ ┌──────────┐       │
│    │  RTMP    │ │  WebRTC  │       │  ← 协议选择
│    │    ●     │ │    ○     │       │
│    └──────────┘ └──────────┘       │
│                                     │
│    ┌─────────────────────────┐     │
│    │                         │     │
│    │      [开始推流]          │     │  ← 主按钮
│    │                         │     │
│    └─────────────────────────┘     │
│                                     │
│    ─────── 最近使用 ───────        │
│    ┌─────────────────────────┐     │
│    │ ▸ rtmp://xxx/live/abc   │     │  ← 历史记录 (可点击选择)
│    │ ▸ rtmp://xxx/live/def   │     │
│    │ ▸ wss://xxx/signal      │     │
│    └─────────────────────────┘     │
│                                     │
└─────────────────────────────────────┘

按钮说明:
📋 - 从剪贴板粘贴
📷 - 打开扫码页面
```

### 3.3 推流页设计

```
┌─────────────────────────────────────┐
│ [←]  00:05:32        [🔴 直播中]    │  ← 状态栏
├─────────────────────────────────────┤
│                                     │
│                                     │
│                                     │
│                                     │
│         [全屏摄像头预览]             │  ← 预览区域
│                                     │
│                                     │
│                                     │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 码率: 2.1Mbps  帧率: 30fps  │   │  ← 状态信息
│  │ 延迟: 120ms    丢帧: 0%     │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│                                     │
│  [🔄]  [🔦]  [🎤]  [✨]  [⏹️]     │  ← 控制栏
│  切换   闪光  静音  美颜  停止       │
│                                     │
└─────────────────────────────────────┘
```

### 3.4 设置页设计

```
┌─────────────────────────────────────┐
│ [←]  设置                           │
├─────────────────────────────────────┤
│                                     │
│  ▼ 视频设置                         │
│  ├─ 分辨率      [1280x720 ▼]       │
│  ├─ 帧率        [30 fps ▼]         │
│  ├─ 码率        [2.0 Mbps ▼]       │
│  └─ 编码器      [H.264 ▼]          │
│                                     │
│  ▼ 音频设置                         │
│  ├─ 采样率      [44100 Hz ▼]       │
│  ├─ 码率        [128 Kbps ▼]       │
│  └─ 声道        [立体声 ▼]          │
│                                     │
│  ▼ 网络设置                         │
│  ├─ 自动重连    [开启 ●]            │
│  ├─ 重连次数    [5 次]              │
│  └─ 连接超时    [10 秒]             │
│                                     │
│  ▼ 高级设置                         │
│  ├─ 关键帧间隔  [2 秒]              │
│  ├─ 硬件编码    [开启 ●]            │
│  └─ 降噪        [开启 ●]            │
│                                     │
│  ▼ 关于                             │
│  ├─ 版本        v1.0.0              │
│  └─ 开源许可                        │
│                                     │
└─────────────────────────────────────┘
```

### 3.5 美颜面板设计

```
┌─────────────────────────────────────┐
│                                     │
│         [摄像头预览区域]             │
│                                     │
├─────────────────────────────────────┤
│  美颜                        [关闭] │
├─────────────────────────────────────┤
│                                     │
│  磨皮  ──────●────────────  70%    │
│                                     │
│  美白  ────────●──────────  50%    │
│                                     │
│  红润  ──●────────────────  20%    │
│                                     │
├─────────────────────────────────────┤
│  滤镜                               │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐      │
│  │原图│ │清新│ │复古│ │黑白│      │
│  │ ●  │ │    │ │    │ │    │      │
│  └────┘ └────┘ └────┘ └────┘      │
│                                     │
└─────────────────────────────────────┘
```

### 3.6 扫码页设计

```
┌─────────────────────────────────────┐
│ [←]  扫描二维码                      │  ← 顶部栏
├─────────────────────────────────────┤
│                                     │
│                                     │
│    ┌─────────────────────────┐     │
│    │ ┌─┐               ┌─┐   │     │
│    │ └─┘               └─┘   │     │
│    │                         │     │
│    │      [扫描框区域]        │     │  ← 相机预览 + 扫描框
│    │      ───────────        │     │  ← 扫描线动画
│    │                         │     │
│    │ ┌─┐               ┌─┐   │     │
│    │ └─┘               └─┘   │     │
│    └─────────────────────────┘     │
│                                     │
│    将二维码放入框内自动扫描          │  ← 提示文字
│                                     │
│    ┌─────────────────────────┐     │
│    │         [🔦 闪光灯]      │     │  ← 闪光灯开关
│    └─────────────────────────┘     │
│                                     │
│    ┌─────────────────────────┐     │
│    │      [📁 从相册选择]     │     │  ← 从图片识别二维码
│    └─────────────────────────┘     │
│                                     │
└─────────────────────────────────────┘

扫描成功后:
• 自动返回首页
• 将扫描到的地址填入输入框
• 如果地址格式正确，自动识别协议类型
```

---

## 4. 操作流程

### 4.1 首次使用流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 启动App │───▶│ 权限申请 │───▶│ 引导页  │───▶│  首页   │
└─────────┘    │ 相机    │    │ 功能介绍│    └─────────┘
               │ 麦克风  │    └─────────┘
               │ 存储    │
               └─────────┘
```

### 4.2 地址输入流程

```
三种方式获取推流地址:

方式1: 手动输入
┌─────────┐    ┌─────────┐    ┌─────────┐
│点击输入框│───▶│输入地址 │───▶│ 验证格式 │───▶ 进入推流
└─────────┘    └─────────┘    └─────────┘

方式2: 粘贴
┌─────────┐    ┌─────────┐    ┌─────────┐
│点击粘贴 │───▶│读取剪贴板│───▶│ 填入地址 │───▶ 进入推流
│  按钮   │    └─────────┘    │ 验证格式 │
└─────────┘                   └─────────┘

方式3: 扫码
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│点击扫码 │───▶│打开相机 │───▶│识别二维码│───▶│ 返回首页 │
│  按钮   │    │扫描页面 │    │ 提取URL │    │ 填入地址 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 4.3 RTMP 推流流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 输入地址 │───▶│ 选RTMP  │───▶│点击开始 │───▶│ 连接中  │
└─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                  │
                    ┌─────────────────────────────┘
                    ▼
               ┌─────────┐    ┌─────────┐
               │推流成功 │───▶│ 推流中  │───▶ [用户点击停止]
               │开始计时 │    │监控状态 │
               └─────────┘    └─────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    ▼                             ▼
               ┌─────────┐                   ┌─────────┐
               │ 正常结束 │                   │ 异常断开 │
               │保存记录 │                   │尝试重连 │
               └─────────┘                   └─────────┘
```

### 4.4 WebRTC 推流流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│输入信令 │───▶│选WebRTC │───▶│点击开始 │───▶│连接信令 │
│服务器   │    └─────────┘    └─────────┘    │ 服务器  │
└─────────┘                                  └────┬────┘
                                                  │
               ┌──────────────────────────────────┘
               ▼
          ┌─────────┐    ┌─────────┐    ┌─────────┐
          │交换SDP  │───▶│ICE协商  │───▶│建立连接 │
          │Offer/   │    │收集候选 │    │ P2P/SFU │
          │Answer   │    └─────────┘    └────┬────┘
          └─────────┘                        │
                                             ▼
                                        ┌─────────┐
                                        │ 推流中  │
                                        └─────────┘
```

### 4.5 断线重连流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│检测断线 │───▶│ 第1次   │───▶│ 等待2秒 │───┐
└─────────┘    │ 重连    │    └─────────┘   │
               └─────────┘                   │
                    ▲                        │
                    │    ┌───────────────────┘
                    │    ▼
                    │ ┌─────────┐    ┌─────────┐
                    │ │重连失败 │───▶│ 第N次   │
                    │ │N < 最大 │    │ 重连    │
                    │ └─────────┘    └────┬────┘
                    │                     │
                    └─────────────────────┘
                                          │
               ┌──────────────────────────┘
               ▼
          ┌─────────┐              ┌─────────┐
          │重连成功 │              │达到上限 │
          │恢复推流 │              │提示用户 │
          └─────────┘              └─────────┘
```

---

## 5. 非功能需求

### 5.1 性能需求

| 指标 | 要求 |
|------|------|
| 启动时间 | < 2 秒 (冷启动) |
| 推流延迟 | RTMP < 3秒, WebRTC < 500ms |
| CPU 占用 | < 30% (1080P/30fps) |
| 内存占用 | < 200 MB |
| 发热控制 | 长时间推流温度 < 45°C |
| 电池消耗 | < 15%/小时 (1080P) |

### 5.2 兼容性需求

| 项目 | 要求 |
|------|------|
| Android 版本 | 7.0 (API 24) 及以上 |
| 屏幕适配 | 支持各种屏幕尺寸和分辨率 |
| 横竖屏 | 支持横竖屏自动切换 |
| 设备兼容 | 主流品牌 (华为、小米、OPPO、vivo、三星等) |

### 5.3 稳定性需求

| 指标 | 要求 |
|------|------|
| 崩溃率 | < 0.1% |
| ANR 率 | < 0.05% |
| 推流成功率 | > 99% |
| 断线重连成功率 | > 95% |

### 5.4 安全需求

| 项目 | 措施 |
|------|------|
| 数据传输 | RTMPS / HTTPS 加密传输 |
| 本地存储 | 敏感信息加密存储 |
| 权限管理 | 最小权限原则 |
| 代码安全 | ProGuard 混淆 |

---

## 6. 版本规划

### 6.1 MVP (v1.0)

- [x] 基础推流功能 (RTMP)
- [x] 摄像头采集与预览
- [x] 基本参数设置
- [x] 推流状态监控

### 6.2 v1.1

- [ ] WebRTC 推流支持
- [ ] 前后摄像头切换
- [ ] 横竖屏切换
- [ ] 断线自动重连

### 6.3 v1.2

- [ ] 基础美颜功能
- [ ] 图片水印
- [ ] 推流历史记录
- [ ] 多推流地址管理

### 6.4 v2.0

- [ ] 高级美颜与滤镜
- [ ] 屏幕录制推流
- [ ] 多平台同时推流
- [ ] 后台推流保活

---

## 7. 风险与依赖

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 设备编码器兼容性差异 | 部分设备推流异常 | 软编码降级方案 |
| WebRTC 信令服务器不稳定 | 无法建立连接 | 多信令服务器备份 |
| 网络环境复杂 | NAT 穿透失败 | 配置 TURN 中继服务器 |
| Android 版本碎片化 | 功能表现不一致 | 充分的兼容性测试 |

### 7.2 外部依赖

| 依赖 | 说明 |
|------|------|
| RTMP 服务器 | 用户自备或使用第三方直播平台 |
| WebRTC 信令服务器 | 需要配套开发或使用开源方案 |
| STUN/TURN 服务器 | 可使用公共服务器或自建 |

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| RTMP | Real-Time Messaging Protocol，实时消息传输协议 |
| WebRTC | Web Real-Time Communication，网页实时通信 |
| SDP | Session Description Protocol，会话描述协议 |
| ICE | Interactive Connectivity Establishment，交互式连接建立 |
| STUN | Session Traversal Utilities for NAT，NAT 会话穿越工具 |
| TURN | Traversal Using Relays around NAT，中继穿越 NAT |
| SFU | Selective Forwarding Unit，选择性转发单元 |
| ABR | Adaptive Bitrate，自适应码率 |

### 8.2 参考资料

- [RTMP 协议规范](https://rtmp.veriskope.com/docs/spec/)
- [WebRTC 官方文档](https://webrtc.org/)
- [Android CameraX 文档](https://developer.android.com/training/camerax)
- [MediaCodec 文档](https://developer.android.com/reference/android/media/MediaCodec)
